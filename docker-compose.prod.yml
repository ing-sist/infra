services:

  # NGINX REVERSE PROXY

  nginx-proxy:
    image: nginx:latest
    container_name: nginx-proxy-prod
    ports:
      # El único que expone puertos a la VM
      - "80:80"
      - "443:443"
    volumes:
      # 1. Monta el archivo de config de Nginx
      - ./nginx.conf/server.prod.conf:/etc/nginx/conf.d/default.conf:ro
      # 2. Certificados SSL (Solo lectura)
      - ./certbot/conf:/etc/letsencrypt:ro
      # 3. Desafío Webroot (Solo lectura)
      - ./certbot/www:/var/www/certbot:ro
    restart: unless-stopped
    depends_on:
      - auth-service-prod
      - engine-service-prod
      - snippet-service-prod
      - printscript-ui-prod

  # === CERTBOT (Generador SSL) ===
  # Se encarga de crear y renovar los certificados automáticamente

  certbot:
    image: certbot/certbot
    container_name: certbot-prod
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    command: certonly --webroot -w /var/www/certbot --email ${CERTBOT_EMAIL} -d ${DUCKDNS_SUBDOMAIN_PROD}.duckdns.org --agree-tos --no-eff-email --keep-until-expiring

  # === DUCKDNS (prod) ===

  duckdns:
    image: lscr.io/linuxserver/duckdns:latest
    container_name: duckdns
    environment:
      - PUID=1000 # ID usuario estandar linux
      - PGID=1000 # ID grupo estandar linux
      - TZ=${TZ}
      - SUBDOMAINS=${DUCKDNS_SUBDOMAIN_PROD}
      - TOKEN=${DUCKDNS_TOKEN}
    restart: unless-stopped

  # === MICROSERVICIOS Y BASES DE DATOS ===

  auth-service-prod:
    image: ghcr.io/ing-sist/auth-service:main-latest
    container_name: auth-service-prod
    env_file:
      -  .env
    expose:
      - 8080
    depends_on:
      auth-service-db-prod:
        condition: service_healthy

  auth-service-db-prod:
    image: postgres:17.6-alpine
    container_name: auth-service-db-prod
    expose:
      - 5432
    env_file:
      - .env
    volumes:
      - auth_data_prod:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped


  snippet-service-prod:
    image: ghcr.io/ing-sist/snippet-service:main-latest
    container_name: snippet-service-prod
    env_file:
      - .env
    expose:
      - 8082
    depends_on:
      snippet-service-db-prod:
        condition: service_healthy

  snippet-service-db-prod:
    image: postgres:17.6-alpine
    container_name: snippet-service-db-prod
    expose:
      - 5432
    env_file:
      - .env
    volumes:
      - snippet_data_prod:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  engine-service-prod:
    image: ghcr.io/ing-sist/engine-service:main-latest
    container_name: engine-service-prod
    env_file:
      - .env
    expose:
      - 8081

  printscript-ui-prod:
    image: ghcr.io/ing-sist/printscript-ui:main-latest
    container_name: printscript-ui-prod
    expose:
      - 80
    restart: unless-stopped

volumes:
  auth_data_prod:
  snippet_data_prod: